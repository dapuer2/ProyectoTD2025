---
title: "ProyectoTD2025    -    Grupo C"
date: "2025-04-08"
output:
  pdf_document:
    toc: true
    toc_depth: 5
    number_sections: false
  html_notebook:
    echo: true
    number_sections: true
    toc: true
  bookdown::pdf_document2:
    toc: true
    toc_depth: 5
    number_sections: false
  html_document:
    echo: true
    number_sections: false
    theme: lumen
    toc: true
  bookdown::html_document2:
    echo: true
    number_sections: false
    theme: spacelab
    toc: true
  word_document:
    toc: true
    toc_depth: '5'
always_allow_html: true
params:
  lang: ES
lang: "`r switch(params$lang, ES = 'es-ES', EN = 'en-US')`"
subtitle: "Tratamiento de Datos. Grado en Ciencia de Datos- UV"
language:
  label:
    fig: 'Figura '
    tab: 'Tabla '
    eq: 'Ecuación '
    thm: 'Teorema '
    lem: 'Lema '
    def: 'Definición '
    cor: 'Corolario '
    prp: 'Proposición '
    exm: 'Ejemplo '
    exr: 'Ejercicio '
    proof: 'Demostración. '
    remark: 'Nota: '
    solution: 'Solución. '
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Introducción

Este proyecto se centra en realizar un análisis detallado de los tickets
electrónicos proporcionados por Mercadona, una reconocida cadena de
supermercados en España. Estos tickets electrónicos son enviados a los
usuarios a través del correo electrónico en formato PDF.

Los datos utilizados en este análisis provienen de los tickets
electrónicos implementados por Mercadona. Estos documentos contienen
información detallada sobre las transacciones de compra realizadas en
sus establecimientos.

El objetivo principal es examinar a fondo estos tickets electrónicos
para obtener información valiosa sobre los hábitos de compra en
Mercadona. Específicamente, se enfocarán en identificar las compras más
comunes, los supermercados más visitados, los productos más populares y
que localidad tiene mayor número de tickets entre otras cosas.

```{r, echo = FALSE, message=FALSE}

if (!require("pacman")) {
  install.packages("pacman")
}

```

```{r, echo = FALSE, warning=FALSE}

library(pacman)

p_load(
  bookdown,
  kableExtra,
  tidyverse, # Manipulación de datos
  readr, # Entrada de datos
  dplyr, # Manipulación de datos
  tidyr, # Manipulación de datos
  purrr, # Manipulación de datos
  lubridate, # Manipulación de datos tipo fecha
  hrbrthemes, # Visualización de datos
  arules # Análisis patrones de compra
  )
```

## 1.2 Extracción de datos del fichero de texto

### 1.2.1 Recopilación de ficheros .txt

Con el propósito de simplificar el procesamiento de los datos contenidos
en los tickets de Mercadona, se ha optado por utilizar un código en R
que convierte los archivos PDF a archivos de txt.

Todos estos archivos se encuentran almacenados en una carpeta compartida
designada para este tipo de archivos [./data], a la cual se accede para
obtener todos los tickets en formato .txt.

Este enfoque permite realizar un análisis línea por línea de cada
documento de manera eficiente y estructurada.

```{r, echo = FALSE}

# Obtenemos todos los ficheros de tipo texto para su siguiente análisis
rutadatos <- './data'
extension = '.txt'
elementos.carpeta <- list.files(path = rutadatos, 
                                pattern = extension,
                                full.names = TRUE, 
                                include.dirs = FALSE)

```

### 1.2.2 Recopilación de los datos

Una vez que todos los tickets han sido recolectados y transformados en
texto plano, es momento de almacenar la información contenida en ellos.
Para ello, hemos realizado 2 data.frames de trabajo:

-   ***df.ticket***: Este data frame recopila la información general de
    cada ticket.

-   ***df.productos***: Este data frame recopila la información de cada
    producto comprado y su precio

#### 1.2.2.1 Recogida de datos generales del ticket

Creamos un data.frame con los datos del ticket

```{r,  echo=FALSE}

# Creamos el dataframe más general que contiene la información individual de
# cada ticket
df.ticket <- data.frame()

for (d in elementos.carpeta) {
  
  contenido <- readLines(d,
                         encoding = 'latin1',
                         warn = FALSE)
  
  # Dirección, Ciudad y Código Postal 
  direccion <- contenido[2]
  
  linea3 <- unlist(strsplit(contenido[3], "\\s+"))
  cp <- linea3[1]
  provincia <- linea3[2]
  
  # Teléfono (ahora en línea 5)
  telefono <- gsub(".*: ", "", contenido[5])
  
  # Fecha, hora y número de operación 
  linea6 <- unlist(strsplit(contenido[6], " "))
  fecha_compra <- linea6[1]
  hora_compra <- linea6[2]
  num_operacion <- gsub("OP: ", "", contenido[7])
  
  # Número de factura simplificada (línea 8)
  num_factura_simpl <- gsub("FACTURA SIMPLIFICADA: ", "", contenido[8])
  

  # Precio total y precio sin IVA 
# Precio total y precio sin IVA 
  # Precio total y precio sin IVA 
patron2 <- "TOTAL"
pos <- grep(patron2, contenido)[1]  # Busca la línea que contiene "TOTAL"
precio_total <- contenido[pos + 1]  # El precio total está en la línea siguiente
precio_total <- as.numeric(gsub(",", ".", precio_total))  # Convierte el precio a numérico

  
  # Buscar todas las apariciones del patrón "TOTAL"
  patron2 <- "TOTAL"
  pos_totales <- grep(patron2, contenido)

  # Precio total (sin IVA) está en la segunda coincidencia de   "TOTAL"
  precio_total_sin_iva <- contenido[pos_totales[2] + 1]  # El precio está en la siguiente línea
  precio_total_sin_iva <- as.numeric(gsub(",", ".", x =precio_total_sin_iva)) 
  
  iva_anyadido <- contenido[pos_totales[2] + 2]  # El precio está en la siguiente línea
  iva_anyadido <- as.numeric(gsub(",", ".", x =iva_anyadido))  

  
  # Detalles de la autorización 
  patronNC <- "N\\.C"
  posNC <- grep(patronNC, contenido)[1]
  nc <- gsub("N.C: ", "", unlist(strsplit( contenido[posNC], " " ))[2])
  aut <- unlist(strsplit( contenido[posNC+1], " " ))[3] 
  aid <- unlist(strsplit( contenido[posNC+1], " " ))[4]
  arc <- unlist(strsplit( contenido[posNC+2], " " ))[2]
  
  # Tipo de tarjeta y método de pago
  autor_trans <- contenido[posNC+3]
  # Buscamos el método de pago 
  patron_metodo_pago <- "TARJETA BANCARIA|Mastercard|Visa"
  pos_metodo_pago <- grep(patron_metodo_pago, contenido)

# Si se encuentra un patrón, asignamos el valor del método de pago
  metodo_pago <- NA
  if (length(pos_metodo_pago) > 0) {
    metodo_pago <- contenido[pos_metodo_pago[1]]  # Tomamos la primera   coincidencia
    metodo_pago <- gsub("TARJETA BANCARIA: ", "", metodo_pago)  #     Eliminar el texto "TARJETA BANCARIA: "
    metodo_pago <- gsub("MASTERCARD", "MASTERCARD", metodo_pago)  # Si es Mastercard
    metodo_pago <- gsub("VISA", "VISA", metodo_pago)  # Si es Visa
}

  
  # Añadimos las variables al dataframe
  fila <- data.frame(
    numero.factura = num_factura_simpl,
    precio.total = as.numeric(precio_total),
    precio.total.sin.IVA = as.numeric(precio_total_sin_iva),
    iva.anyadido = as.numeric(iva_anyadido),
    direccion = as.factor(direccion),
    ciudad = as.factor(provincia),
    codigo.postal = as.factor(cp),
    telefono = as.character(telefono),
    fecha = dmy(fecha_compra),
    hora = hm(hora_compra),
    tipo.tarjeta = as.factor(autor_trans),
    metodo.pago = as.factor(metodo_pago),
    autorizacion.pago = aut,
    identificacion.aplicacion.pago = arc,
    autorizacion.transaccion = as.factor(autor_trans),
    numero.centro = nc,
    numero.caja = num_operacion
  )
  
  df.ticket <- bind_rows(df.ticket, fila)
}
```

```{r, echo= FALSE, message=FALSE, warning=FALSE}

df.productos <- data.frame()

for (d in elementos.carpeta) {
  
  contenido <- readLines(d,
                       encoding = 'utf-8',
                       warn = FALSE)
  
  # Extraemos información del ticket
  num_factura_simpl <- gsub("FACTURA SIMPLIFICADA: ", "", contenido[8])
  fecha_compra <- dmy(unlist(strsplit(contenido[6], " "))[1])
  
  # Identificamos la sección de productos (después de "Importe" y antes de "TOTAL")
  inicio_productos <- grep("Importe", contenido) + 1
  fin_productos <- grep("TOTAL \\(â‚¬\\)", contenido) - 1
  
  # Si no encontramos el patrón exacto, buscamos alternativas
  if(length(fin_productos) == 0) {
    fin_productos <- grep("^TOTAL$", contenido)[1] - 1
    if(is.na(fin_productos)) {
      fin_productos <- grep("TARJETA BANCARIA", contenido) - 1
    }
  }
  
  productos <- contenido[inicio_productos:fin_productos]
  
  # Eliminamos líneas de PARKING si existen
  patron_parking <- "PARKING"
  lineas_parking <- grep(patron_parking, productos)
  if(length(lineas_parking) > 0) {
    productos <- productos[-lineas_parking]
  }
  
  # Eliminamos líneas de DONACIÓN si existen
  patron_donacion <- "DONACIÃ“N"
  lineas_donacion <- grep(patron_donacion, productos)
  if(length(lineas_donacion) > 0) {
    productos <- productos[-lineas_donacion]
  }
  
  # Procesamos los productos
  i <- 1
  while(i <= length(productos)) {
    # Inicializamos variables
    cantidad <- NA
    nombre_producto <- NA
    precio_producto <- NA
    
    # Patrón 1: Cantidad (1 línea), Nombre (1 línea), Precio (1 línea)
    if(grepl("^\\d+$", productos[i])) {
      cantidad <- as.numeric(productos[i])
      nombre_producto <- productos[i+1]
      precio_producto <- as.numeric(gsub(",", ".", productos[i+2]))
      i <- i + 3
    } 
    # Patrón 2: Línea combinada (cantidad + nombre + precio)
    else if(grepl("^\\d+ ", productos[i])) {
      elementos <- unlist(strsplit(productos[i], " "))
      cantidad <- as.numeric(elementos[1])
      nombre_producto <- paste(elementos[-length(elementos)][-1], collapse = " ")
      precio_producto <- as.numeric(gsub(",", ".", elementos[length(elementos)]))
      i <- i + 1
    }
    # Patrón 3: Productos con peso (simplificado - solo tomamos el precio total)
    else if(grepl("[0-9],", productos[i]) && grepl("€", productos[i+1])) {
      nombre_producto <- productos[i]
      datos_peso <- unlist(strsplit(productos[i+1], " "))
      precio_producto <- as.numeric(gsub(",", ".", datos_peso[5])) # Tomamos el precio total
      cantidad <- 1  
      i <- i + 2
    } 
    # Si no coincide con ningún patrón, avanzamos
    else {
      i <- i + 1
      next
    }
    
    # Añadimos el producto al dataframe
    if(!is.na(nombre_producto)) {
      fila <- data.frame(
        numero.factura = num_factura_simpl,
        fecha = fecha_compra,
        cantidad = as.numeric(cantidad),
        nombre.producto = nombre_producto,
        precio.producto = as.numeric(precio_producto),
        stringsAsFactors = FALSE
      )
      df.productos <- bind_rows(df.productos, fila)
    }
  }
}
# Limpieza final de los datos
df.productos <- df.productos %>%filter(!is.na(nombre.producto), !is.na(precio.producto))


```

#### 1.2.2.2 Descripción de las variables del ticket

Las variables creadas y almacenadas para esta tabla con datos más
generales es la siguiente:

-   ***numero.factura***: Es una variable de tipo texto que identifica
    unívocamente cada ticket analizado durante el transcurso del
    análisis.
-   ***precio.total***: Es una variable de tipo numérico que informa
    sobre el valor del precio total del ticket
-   ***precio.total.sin.IVA***: Es una variable de tipo numérico que
    informa sobre el valor del precio total del ticket, quitando todo el
    IVA añadido a cada producto.
-   ***iva.anyadido***: Es una variable de tipo numérico que informa
    sobre el valor total de IVA añadido a todos los productos.
-   ***direccion***: Es una variable de tipo categórico que informa
    sobre la dirección del Mercadona donde se realizó la compra.
-   ***ciudad***: Es una variable de tipo categórico que informa sobre
    la ciudad donde se realizó la compra.
-   ***codigo.postal***: Es una variable de tipo categórico que,
    análogamente a la ciudad, informa sobre el código postal que tiene
    la ciudad donde se realizó la compra.
-   ***telefono***: Es un valor de tipo texto que indica el número de
    teléfono del Mercadona donde se realizó la compra.
-   ***fecha***: Es una variable de tipo fecha que indica el día en el
    que se realizó la compra.
-   ***hora***: Es una variable de tipo periodo que indica la hora
    exacta en la que se realizó el pago de la compra.
-   ***tipo.tarjeta***: Es una variable de tipo categórico que
    representa las marcas de tarjetas de crédito o débito utilizadas
    junto con la indicación de VERIFICADO POR DISPOSITIVO, que
    representa un método adicional de autenticación.
-   ***metodo.pago***: Es una variable de tipo categórico que representa
    los diferentes métodos de pago utilizados en las transacciones
    registradas.
-   ***autorizacion.pago***: Es una variable de tipo texto que
    representa la autorización del banco con respecto al pago
    solicitado.
-   ***identificacion.aplicacion.pago***: Es una variable de tipo texto
    que representa la identifficación de la aplicación bancaria
    utilizada a la hora de realizar el pago.
-   ***autorizacion.transaccion***: Es una variable de tipo texto que
    representa el tipo de transacción realizada.
-   ***numero.centro***: Es una variable de tipo texto que representa el
    número asociado al centro donde se ha realizado la compra.
-   ***numero.caja***: Es una variable de tipo texto que representa la
    caja en la que el usuario ha sido atendido.

Los nombres de las variables son bastante descriptivos pero es necesaria
una pequeña explicación sobre ellos para en caso de olvidarse o retomar
el proyecto en un futuro sea fácil su entendimiento y rápida la puesta
en marcha.

```{r, echo = FALSE, warning=FALSE}
# Realizamos las tablas necesarias para visualizar el análisis llevado a cabo:

## TABLA 1: Resumen general de variables
resumen_variable <- function(var) {
  tipo <- class(var)[1]
  n_na <- sum(is.na(var))
  miss_frac <- round(mean(is.na(var)), 4)

  if (is.factor(var) || is.character(var)) {
    niveles <- length(unique(var))
    top <- names(sort(table(var), decreasing = TRUE))[1]
    top_count <- max(table(var))
    top_frac <- round(top_count / length(var), 4)
  } else {
    niveles <- NA
    top <- NA
    top_count <- NA
    top_frac <- NA
  }

  tibble(
    tipo = tipo,
    niveles = niveles,
    topLevel = top,
    topCount = top_count,
    topFrac = top_frac,
    missFrac = miss_frac
  )
}

resumen <- bind_rows(lapply(df.ticket, resumen_variable), .id = "Variable")

knitr::kable(
  resumen,
  caption = "Tabla 1. Resumen general de las variables del conjunto de tickets.",
  digits = 4
) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

# La tabla 1 presenta un resumen de las variables contenidas en df.ticket, indicando el tipo, número de niveles (si corresponde), valor más frecuente, su frecuencia relativa y la fracción de valores perdidos.

```

```{r, echo = FALSE}
## TABLA 2: Estadísticos de variables numéricas
numericas <- df.ticket %>%
  select(where(is.numeric)) %>%
  summarise(across(
    everything(),
    list(
      Media = mean,
      Mediana = median,
      DesvEst = sd,
      Min = min,
      Max = max
    ),
    na.rm = TRUE
  )) %>%
  pivot_longer(cols = everything(),
               names_to = c("Variable", ".value"),
               names_sep = "_")

knitr::kable(
  numericas,
  caption = "Tabla 2. Estadísticos descriptivos de las variables numéricas.",
  digits = 2
) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

# En la tabla 2 se muestran los principales estadísticos descriptivos de las variables cuantitativas como el precio total del ticket, el IVA añadido y el precio sin IVA.
```

```{r, echo = FALSE}
## TABLA 3: Frecuencias de variables categóricas clave
categoricas <- df.ticket %>%
  select_if(~ is.factor(.) || is.character(.)) %>%
  select(ciudad, metodo.pago, numero.centro) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Valor") %>%
  group_by(Variable, Valor) %>%
  summarise(Frecuencia = n(), .groups = "drop") %>%
  group_by(Variable) %>%
  arrange(desc(Frecuencia), .by_group = TRUE) %>%
  slice_head(n = 5)  # top 5 por categoría

knitr::kable(
  categoricas,
  caption = "Tabla 3. Frecuencia de los valores más comunes en variables categóricas clave.",
  digits = 0
) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

# La tabla 3 muestra las frecuencias más altas de tres variables categóricas clave: ciudad, método de pago y número de centro, lo que permite comenzar a observar patrones interesantes en los tickets.
```

## 1.3 Preguntas propuestas

Estas son las preguntas que tenemos que responder mediante gráficos.

-   ¿Cuáles son los 5 productos, de los vendidos por unidades, con más
    ventas ? ¿Cuántas unidades de cada uno se han vendido ?Ç

-   Si consideramos la categoría de FRUTAS Y VERDURAS. Cuáles son los 5
    productos más vendidos ? ¿Cuántos kilos se han vendido de cada uno
    de estos productos ?

-   Si consideramos la categoría de PESCADO. Cuáles son los 5 productos
    más vendidos ? ¿Cuántos kilos se han vendido de cada uno de estos
    productos ?

-   Muestra mediante un gráfico de líneas como ha variado el precio por
    kilo de las bananas y los plátanos en los tickets disponibles, a lo
    largo del tiempo.

-   ¿ Cuál es la procedencia de los tickets ?¿ Qué ciudad/ pueblo tiene
    un mayor número de tickets ?

-   Muestra mediante un diagrama el número de tickets recogidos cada día
    de las semana. ¿Si tuvieses que cerrar un día entre semana qué día
    lo harías ?

-   ¿Existe algún patrón en cuanto a la hora del día en que se realizan
    las compras?

-   ¿Cuánto dinero de media se gastan los compradores?

-   ¿Cuanto dinero se suele añadir con el IVA?

-   ¿Cuál es la tienda en la que más se ha comprado ? (Dirección tienda)

-   ¿Cuál es el alimento comprado más caro?

### Pregunta propuestas 1.3.1

\# - ¿Cuáles son los 5 productos, de los vendidos por unidades, con más
ventas ? ¿Cuántas unidades de cada uno se han vendido ?

```{r echo=FALSE, fig.cap="**Figure 1.** Top 5 productos más vendidos por unidades", fig.align="center"}
top_productos<-df.productos%>%
  group_by(nombre.producto)%>%# Primero agrupamos por los productos
  summarise(Unidades_Vendidas=sum(cantidad))%>%# Sumamos la cantidad de cada cantidad
  arrange(desc(Unidades_Vendidas))# Ordenamos las cantidades de manera descendente

top9<-head(top_productos,9)
ggplot(top9,aes(x=nombre.producto,y=Unidades_Vendidas))+
  geom_col(fill="lightgreen")+# Usamos el parametro fill para cambiar el color de relleno de las barras
  geom_text(aes(label=Unidades_Vendidas),vjust=-0.1)+# Para poner la cantidad encima de cada barra
  labs(title="Top 5 productos más vendidos por unidades",x="Producto",y="Unidades Vendidas"
  )+theme_minimal()+theme(axis.text.x=element_text(angle=45,hjust=1,size=10))# Usamos element_text para ajustar los nombres de los productos que estan en el eje X
```

**Análisis:** En esta gráfica podemos observar los productos más vendidos por unidades. El producto con mayor número de ventas es la leche desnatada sin lactosa, con 24 unidades, seguido de las lonchas de queso de cabra con 20. También destacan productos como los yogures Activia, los copos de avena o la barra de pan campesina. Aunque el título indica un Top 5, se han incluido más productos para ofrecer una visión más completa del comportamiento de ventas. Este análisis permite identificar los productos más demandados.
