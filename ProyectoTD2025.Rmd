---
title: "ProyectoTD2025    -    Grupo C"
author: "Alexandra Alfonso, Alberto Cabedo, Javier Marzo, Iker Pérez, David Puertes y Julio Sierra"
date: "2025-04-08"
output:
  pdf_document:
    toc: true
    toc_depth: 5
    number_sections: false
  html_notebook:
    echo: true
    number_sections: true
    toc: true
  bookdown::pdf_document2:
    toc: true
    toc_depth: 5
    number_sections: false
  html_document:
    echo: true
    number_sections: false
    theme: lumen
    toc: true
  bookdown::html_document2:
    echo: true
    number_sections: false
    theme: spacelab
    toc: true
  word_document:
    toc: true
    toc_depth: '5'
always_allow_html: true
params:
  lang: ES
lang: "`r switch(params$lang, ES = 'es-ES', EN = 'en-US')`"
subtitle: "Tratamiento de Datos. Grado en Ciencia de Datos- UV"
language:
  label:
    fig: 'Figura '
    tab: 'Tabla '
    eq: 'Ecuación '
    thm: 'Teorema '
    lem: 'Lema '
    def: 'Definición '
    cor: 'Corolario '
    prp: 'Proposición '
    exm: 'Ejemplo '
    exr: 'Ejercicio '
    proof: 'Demostración. '
    remark: 'Nota: '
    solution: 'Solución. '
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Introducción

Este proyecto se centra en realizar un análisis detallado de los tickets
electrónicos proporcionados por Mercadona, una reconocida cadena de
supermercados en España. Estos tickets electrónicos son enviados a los
usuarios a través del correo electrónico en formato PDF.

Los datos utilizados en este análisis provienen de los tickets
electrónicos implementados por Mercadona. Estos documentos contienen
información detallada sobre las transacciones de compra realizadas en
sus establecimientos.

El objetivo principal es examinar a fondo estos tickets electrónicos
para obtener información valiosa sobre los hábitos de compra en
Mercadona. Específicamente, se enfocarán en identificar las compras más
comunes, los supermercados más visitados, los productos más populares y
que localidad tiene mayor número de tickets entre otras cosas.

```{r, echo = FALSE, message=FALSE}

if (!require("pacman")) {
  install.packages("pacman")
}

```

## 2. Carga de librerías necesarias para el análisis

Inicialmente, se cargan los paquetes necesarios para cada una de las
fases del proyecto. Para hacerlo de forma más eficiente y ordenada, se
utiliza el paquete pacman del lenguaje de programación R

```{r, echo = FALSE, warning=FALSE}

library(pacman)

p_load(
  bookdown,
  kableExtra,
  tidyverse, # Manipulación de datos
  readr, # Entrada de datos
  dplyr, # Manipulación de datos
  tidyr, # Manipulación de datos
  purrr, # Manipulación de datos
  lubridate, # Manipulación de datos tipo fecha
  hrbrthemes, # Visualización de datos
  arules # Análisis patrones de compra
  )
```

## 3. Extracción de datos del fichero de texto

### 3.1 Recopilación de ficheros .txt

Con el propósito de simplificar el procesamiento de los datos contenidos
en los tickets de Mercadona, se ha optado por utilizar un código en R
que convierte los archivos PDF a archivos de txt.

Todos estos archivos se encuentran almacenados en una carpeta compartida
designada para este tipo de archivos [./data], a la cual se accede para
obtener todos los tickets en formato .txt.

Este enfoque permite realizar un análisis línea por línea de cada
documento de manera eficiente y estructurada.

```{r, echo = FALSE}

# Obtenemos todos los ficheros de tipo texto para su siguiente análisis
rutadatos <- './data'
extension = '.txt'
elementos.carpeta <- list.files(path = rutadatos, 
                                pattern = extension,
                                full.names = TRUE, 
                                include.dirs = FALSE)

```

### 3.2 Recopilación de los datos

Una vez que todos los tickets han sido recolectados y transformados en
texto plano, es momento de almacenar la información contenida en ellos.
Para ello, hemos realizado 2 data.frames de trabajo:

-   ***df.ticket***: Este data frame recopila la información general de
    cada ticket.

-   ***df.productos***: Este data frame recopila la información de cada
    producto comprado y su precio

#### 3.2.1 Recogida de datos generales del ticket

Las variables creadas y almacenadas para esta tabla con datos más
generales es la siguiente:

-   ***numero.factura***: Es una variable de tipo texto que identifica
    unívocamente cada ticket analizado durante el transcurso del
    análisis.
-   ***precio.total***: Es una variable de tipo numérico que informa
    sobre el valor del precio total del ticket
-   ***precio.total.sin.IVA***: Es una variable de tipo numérico que
    informa sobre el valor del precio total del ticket, quitando todo el
    IVA añadido a cada producto.
-   ***iva.anyadido***: Es una variable de tipo numérico que informa
    sobre el valor total de IVA añadido a todos los productos.
-   ***direccion***: Es una variable de tipo categórico que informa
    sobre la dirección del Mercadona donde se realizó la compra.
-   ***ciudad***: Es una variable de tipo categórico que informa sobre
    la ciudad donde se realizó la compra.
-   ***codigo.postal***: Es una variable de tipo categórico que,
    análogamente a la ciudad, informa sobre el código postal que tiene
    la ciudad donde se realizó la compra.
-   ***telefono***: Es un valor de tipo texto que indica el número de
    teléfono del Mercadona donde se realizó la compra.
-   ***fecha***: Es una variable de tipo fecha que indica el día en el
    que se realizó la compra.
-   ***hora***: Es una variable de tipo periodo que indica la hora
    exacta en la que se realizó el pago de la compra.
-   ***tipo.tarjeta***: Es una variable de tipo categórico que
    representa las marcas de tarjetas de crédito o débito utilizadas
    junto con la indicación de VERIFICADO POR DISPOSITIVO, que
    representa un método adicional de autenticación.
-   ***metodo.pago***: Es una variable de tipo categórico que representa
    los diferentes métodos de pago utilizados en las transacciones
    registradas.
-   ***autorizacion.pago***: Es una variable de tipo texto que
    representa la autorización del banco con respecto al pago
    solicitado.
-   ***identificacion.aplicacion.pago***: Es una variable de tipo texto
    que representa la identifficación de la aplicación bancaria
    utilizada a la hora de realizar el pago.
-   ***autorizacion.transaccion***: Es una variable de tipo texto que
    representa el tipo de transacción realizada.
-   ***numero.centro***: Es una variable de tipo texto que representa el
    número asociado al centro donde se ha realizado la compra.
-   ***numero.caja***: Es una variable de tipo texto que representa la
    caja en la que el usuario ha sido atendido.

```{r,  echo=FALSE}

# Creamos el dataframe más general que contiene la información individual de
# cada ticket
df.ticket <- data.frame()

for (d in elementos.carpeta) {
  
  contenido <- readLines(d,
                         encoding = 'utf-8',
                         warn = FALSE)
  
  # Dirección, Ciudad y Código Postal 
  direccion <- contenido[2]
  
  linea3 <- unlist(strsplit(contenido[3], "\\s+"))
  cp <- linea3[1]
  provincia <- linea3[2]
  
  # Teléfono (ahora en línea 5)
  telefono <- gsub(".*: ", "", contenido[5])
  
  # Fecha, hora y número de operación 
  linea6 <- unlist(strsplit(contenido[6], " "))
  fecha_compra <- linea6[1]
  hora_compra <- linea6[2]
  num_operacion <- gsub("OP: ", "", contenido[7])
  
  # Número de factura simplificada (línea 8)
  num_factura_simpl <- gsub("FACTURA SIMPLIFICADA: ", "", contenido[8])
  

  # Precio total y precio sin IVA 
# Precio total y precio sin IVA 
  # Precio total y precio sin IVA 
patron2 <- "TOTAL"
pos <- grep(patron2, contenido)[1]  # Busca la línea que contiene "TOTAL"
precio_total <- contenido[pos + 1]  # El precio total está en la línea siguiente
precio_total <- as.numeric(gsub(",", ".", precio_total))  # Convierte el precio a numérico

  
  # Buscar todas las apariciones del patrón "TOTAL"
  patron2 <- "TOTAL"
  pos_totales <- grep(patron2, contenido)

  # Precio total (sin IVA) está en la segunda coincidencia de   "TOTAL"
  precio_total_sin_iva <- contenido[pos_totales[2] + 1]  # El precio está en la siguiente línea
  precio_total_sin_iva <- as.numeric(gsub(",", ".", x =precio_total_sin_iva)) 
  
  iva_anyadido <- contenido[pos_totales[2] + 2]  # El precio está en la siguiente línea
  iva_anyadido <- as.numeric(gsub(",", ".", x =iva_anyadido))  

  
  # Detalles de la autorización 
  patronNC <- "N\\.C"
  posNC <- grep(patronNC, contenido)[1]
  nc <- gsub("N.C: ", "", unlist(strsplit( contenido[posNC], " " ))[2])
  aut <- unlist(strsplit( contenido[posNC+1], " " ))[3] 
  aid <- unlist(strsplit( contenido[posNC+1], " " ))[4]
  arc <- unlist(strsplit( contenido[posNC+2], " " ))[2]
  
  # Tipo de tarjeta y método de pago
  autor_trans <- contenido[posNC+3]
  # Buscamos el método de pago 
  patron_metodo_pago <- "TARJETA BANCARIA|Mastercard|Visa"
  pos_metodo_pago <- grep(patron_metodo_pago, contenido)

# Si se encuentra un patrón, asignamos el valor del método de pago
  metodo_pago <- NA
  if (length(pos_metodo_pago) > 0) {
    metodo_pago <- contenido[pos_metodo_pago[1]]  # Tomamos la primera   coincidencia
    metodo_pago <- gsub("TARJETA BANCARIA: ", "", metodo_pago)  #     Eliminar el texto "TARJETA BANCARIA: "
    metodo_pago <- gsub("MASTERCARD", "MASTERCARD", metodo_pago)  # Si es Mastercard
    metodo_pago <- gsub("VISA", "VISA", metodo_pago)  # Si es Visa
}

  
  # Añadimos las variables al dataframe
  fila <- data.frame(
    numero.factura = num_factura_simpl,
    precio.total = as.numeric(precio_total),
    precio.total.sin.IVA = as.numeric(precio_total_sin_iva),
    iva.anyadido = as.numeric(iva_anyadido),
    direccion = as.factor(direccion),
    ciudad = as.factor(provincia),
    codigo.postal = as.factor(cp),
    telefono = as.character(telefono),
    fecha = dmy(fecha_compra),
    hora = hm(hora_compra),
    tipo.tarjeta = as.factor(autor_trans),
    metodo.pago = as.factor(metodo_pago),
    autorizacion.pago = aut,
    identificacion.aplicacion.pago = arc,
    autorizacion.transaccion = as.factor(autor_trans),
    numero.centro = nc,
    numero.caja = num_operacion
  )
  
  df.ticket <- bind_rows(df.ticket, fila)
}
```

#### 3.2.2 Recogida de datos de los productos del ticket

Las variables creadas y almacenadas para la tabla de los productos es
la siguiente:

-   ***numero.factura***: Es una variable de tipo texto que identifica
    unívocamente cada ticket analizado durante el transcurso del
    análisis.
-   ***cantidad***: Es una variable de tipo numérico que informa sobre
    la cantidad de productos comprados. En el caso en el que el producto
    esté condicionado por la variable peso, la cantidad será indicada
    como 1.
-   ***nombre.producto***: Es una variable de tipo categórico que
    informa sobre el nombre del producto.
-   ***precio.producto***: Es una variable de tipo numérico que indica
    el valor del producto por una unidad del mismo. Es decir, no tiene
    en cuenta la cantidad de productos de ese nombre comprados.


Los nombres de las variables son bastante descriptivos pero es necesaria
una pequeña explicación sobre ellos para en caso de olvidarse o retomar
el proyecto en un futuro sea fácil su entendimiento y rápida la puesta
en marcha.

```{r, echo= FALSE, message=FALSE, warning=FALSE}
df.productos <- data.frame()

for (d in elementos.carpeta) {
  
  contenido <- readLines(d,
                         encoding = 'utf-8',
                         warn = FALSE)
  
  # Extraemos información del ticket
  num_factura_simpl <- gsub("FACTURA SIMPLIFICADA: ", "", contenido[8])
  fecha_compra <- dmy(unlist(strsplit(contenido[6], " "))[1])
  
  # Identificamos la sección de productos
  inicio_productos <- grep("Importe", contenido) + 1
  fin_productos <- grep("TOTAL(€))", contenido) - 1
  
  if(length(fin_productos) == 0) {
    fin_productos <- grep("^TOTAL$", contenido)[1] - 1
    if(is.na(fin_productos)) {
      fin_productos <- grep("TARJETA BANCARIA", contenido) - 1
    }
  }
  
  productos <- contenido[inicio_productos:fin_productos]
  productos <- trimws(productos)
  productos <- productos[productos != ""]
  
  # Eliminar líneas irrelevantes
  productos <- productos[!grepl("PARKING|DONACIÓN", productos, ignore.case = TRUE)]
  
  # Procesamos los productos
  i <- 1
  while(i <= length(productos)) {
    cantidad <- NA
    nombre_producto <- NA
    precio_producto <- NA
    
    # PATRÓN PESO (5 líneas): cantidad, nombre, peso, €/kg, total
    if((i + 4 <= length(productos)) &&
       grepl("^\\d+$", productos[i]) &&
       grepl("^[A-Za-zÁÉÍÓÚÜÑ ]+$", productos[i + 1]) &&
       grepl("^\\d+,\\d+ kg$", productos[i + 2]) &&
       grepl("^\\d+,\\d+ €/kg$", productos[i + 3]) &&
       grepl("^\\d+,\\d+$", productos[i + 4])) {
      
      cantidad <- as.numeric(productos[i])
      nombre_producto <- trimws(productos[i + 1])
      precio_producto <- as.numeric(gsub(",", ".", productos[i + 4]))
      i <- i + 5
    }
    
    # PATRÓN 1: cantidad, nombre, precio en líneas separadas
    else if(grepl("^\\d+$", productos[i]) && (i + 2 <= length(productos))) {
      cantidad <- as.numeric(productos[i])
      nombre_producto <- productos[i + 1]
      precio_producto <- as.numeric(gsub(",", ".", productos[i + 2]))
      i <- i + 3
    } 
    
    # PATRÓN 2: todo en una línea (ej: "1 PAN BARRA 0,55")
    else if(grepl("^\\d+ ", productos[i])) {
      elementos <- unlist(strsplit(productos[i], " "))
      cantidad <- as.numeric(elementos[1])
      nombre_producto <- paste(elementos[2:(length(elementos) - 1)], collapse = " ")
      precio_producto <- as.numeric(gsub(",", ".", elementos[length(elementos)]))
      i <- i + 1
    }

        # PATRÓN 3: nombre, luego precio
    else if((i + 1 <= length(productos)) &&
            grepl("[a-zA-Z]", productos[i]) &&
            !grepl("TOTAL|TARJETA|IVA|CUOTA|BASE IMPONIBLE|€/kg|kg|g|litro|unidad|u\\.", productos[i], ignore.case = TRUE) &&
            grepl("[0-9]+,[0-9]+", productos[i + 1]) &&
            !grepl("TOTAL|TARJETA|IVA|CUOTA|BASE IMPONIBLE|€/kg|kg|g|litro|unidad|u\\.", productos[i + 1], ignore.case = TRUE)) {
      
      nombre_producto <- trimws(productos[i])
      precio_texto <- productos[i + 1]
      precio_extraido <- str_extract(precio_texto, "[0-9]+,[0-9]+")
      
      if (!is.na(precio_extraido)) {
        precio_producto <- as.numeric(gsub(",", ".", precio_extraido))
        cantidad <- 1
      }
      
      i <- i + 2
    }

    # Ningún patrón coincide
    else {
      i <- i + 1
      next
    }
    
    # Añadimos al dataframe si hay nombre válido
    if(!is.na(nombre_producto)) {
      fila <- data.frame(
        numero.factura = num_factura_simpl,
        fecha = fecha_compra,
        cantidad = cantidad,
        nombre.producto = nombre_producto,
        precio.producto = precio_producto,
        stringsAsFactors = FALSE
      )
      df.productos <- bind_rows(df.productos, fila)
    }
  }
}

# Limpieza final
df.productos <- df.productos %>%
  filter(!is.na(nombre.producto), !is.na(precio.producto))
```

Consideramos también la clasificació por categoría de los distintos productos almacenados en el ***df.productos***.

```{r, include=FALSE, message=FALSE, warning=FALSE}

df.productos <- df.productos %>%
  mutate(categoria = case_when(
    # FRUTAS Y VERDURAS
    nombre.producto %in% c("PATATA 3 KG", "TOMATE ENTERO PELADO", "AJO SECO 250 G", 
                           "CHAMPIÑÓN GRANDE BAN", "MANZANA GOLDEN BOLSA", "ESP VERDE FINO",
                           "SETA BANDEJA", "CHAMPIÑON PORTOBELLO", "FRESÓN", "AGUACATE BANDEJA",
                           "MANDARINA", "PLATANO", "ALCACHOFA", "HABAS", "MANDARINA HOJA",
                           "BURGER BERENJENA", "BANANA", "CALABACIN VERDE", "COLIFLOR",
                           "JUDÍA PLANA", "KIWI VERDE", "CEBOLLA 2 KG", "RABANITOS",
                           "CEBOLLA TIERNA", "TOMATE NEGRO", "MANGO", "TOMATE CANARIO", "GARROFON", "TOMATE TRITURADO", "TOMATE TRITURADO", "GUISANTE FINO", "ZANAHORIA BOLSA", "PEPINO", "UVA BLANCA S/SEM") ~ "FRUTAS Y VERDURAS",
    
    # PESCADO
    nombre.producto %in% c("MEJILLON", "PATÉ ATÚN 3X80", "MARINA ALTA", "ALBONDIGAS DE BACALA",
                           "BERBERECHO", "LOMO BACAL P/S", "ESCALOPIN SALMON", "BACALAO AHUMADO", "TIBURON", "ATÚN CLARO OLIVA PK6
") ~ "PESCADO",
    
    # CARNES Y EMBUTIDOS
    nombre.producto %in% c("CHULETA AGUJA", "CH. PALO RIÑONAD", "MORCILLA CEB. OREADA",
                           "1/2 CONEJO TROCEADO", "F. PLANCHA/GUISAR", "CHULETON", "CHORIZO",
                           "LONGANIZA DE PAYES", "LONGANIZA PASCUA", "EMBUTIDO LONCHEADO",
                           "SALCHICHÓN BELLOTA", "JAMON CEBO IBERICO", "JAMÓN C FL PACK",
                           "TACO BACON", "HAMBURGUESA DE LOMO", "ALAS PARTIDAS CERT",
                           "COSTILLA CARNOSA", "GARRÓN JAMON SERRANO", "SALCHICHON CEBO LONC",
                           "JAMÓN COCIDO 90%", "CHORIZO PICANTE", "PANCETA", "POLLO ENTERO LIMPIO", "ALBONDIGAS 24 UNID.
") ~ "CARNES Y EMBUTIDOS",
    
    # LÁCTEOS Y QUESOS
    nombre.producto %in% c("Q VIEJO TOSTADO", "QUESO LONCHAS OVEJA", "LECHE ENTERA P6",
                           "LCASEI FRESA X", "ACT O% NAT ED", "TARTA QUESO", 
                           "Q RALLADO FUNDIR", "Q. UNTAR SUAVE", "GRIEGO STRACCIAT.P-6",
                           "ACT O% NAT ED 8", "NATILLA CHOCOLATE X4", "NATA 15% SIN LACTOSA", "QUESO AÑEJO ROMERO", "Q. VIEJO INTENSO", "Q. RALLADO EMMENTAL", "QUESO RALLADO PIZZA", "QUESO FRESCO CABRA
", "LECHE DESNAT. CALCIO
") ~ "LÁCTEOS Y QUESOS",
    
    # PANADERÍA Y REPOSTERÍA
    nombre.producto %in% c("C 0,0 TOSTADA P-6", "PAT. CLASSICAS", "MINI EMP PISTO P6",
                           "M.CROISS MANTEQUILLA", "PAN 51% INTEGRAL 5UN", "MINI SALADAS",
                           "GALL.MARIA INTEGRAL", "GALLETA MARIA", "BARRITAS CHIPS AHOY",
                           "CONOS", "TRIGO SNACKS", "PAN CRISTAL 4 UDS", "PAN REDONDO SEMILLAS") ~ "PANADERÍA Y REPOSTERÍA",
    
    # LEGUMBRES Y CEREALES
    nombre.producto %in% c("GARBANZO M.COCIDO", "ARROZ INTEGRAL", "COPOS DE AVENA",
                           "QUINOA") ~ "LEGUMBRES Y CEREALES",
    
    # FRUTOS SECOS
    nombre.producto %in% c("AVELLANA TOSTADA", "CACAHUETE SIN SAL", "NUEZ CASCARA NATURAL", "ANACARDO NATURAL") ~ "FRUTOS SECOS",
    
    # ALIMENTOS PREPARADOS
    nombre.producto %in% c("TOFU", "SOJA NATURAL CAJA", "BURGER BERENJENA", 
                           "PIZZA ATUN BACON", "PIZZA MEDITTERRANEA") ~ "ALIMENTOS PREPARADOS",
    
    # BEBIDAS
    nombre.producto %in% c("C. ESPECIAL BOT", "CERV TOSTADA", "CERV PACK", "RIBERA ROBLE",
                           "ICE TEA MELOCOTÓN", "CERVEZA", "ISOTÓNICA LIMÓN
", "CERV. RADLER 0,0", "AGUA MINERAL") ~ "BEBIDAS",
    
    # CONDIMENTOS Y SALSAS
    nombre.producto %in% c("SALSA MIEL Y MOSTAZA", "SALSA AGRIDULCE", "MIEL NARANJO DOSIF.",
                           "MAYONESA L LIGHT", "VIRGEN EXTRA") ~ "CONDIMENTOS Y SALSAS",
    
    # PRODUCTOS DE LIMPIEZA
    nombre.producto %in% c("LAVAVAJILLAS QUANTUM", "ABRILLANTADOR VAJILL", "LAVAVAJILLA TODO 1",
                           "LAVAVAJILLA TODO", "LAVAVAJ. TODO EN", "ARIEL CÁPSULAS",
                           "FAIRY ORIGINAL 870ML", "LIMPIAHOGAR MULTI", "LIMPIADOR MOPAS SPRA",
                           "SAL LAVAVAJILLAS", "REFILL DERMO", "BARREÑO", "MULTIUSOS", "FRIEGASUELOS PINO") ~ "PRODUCTOS DE LIMPIEZA",
    
    # HIGIENE PERSONAL
    nombre.producto %in% c("TAMPÓN C. PEARL REGU", "ROLLO HOGAR DOBLE", "PAÑUELO CAJA",
                           "TOA.BEBE FRESCAS", "CHAMPÚ H&S 2 EN", "TOALLITAS ANTITRANSF") ~ "HIGIENE PERSONAL",
    
    # OTROS ALIMENTOS
    nombre.producto %in% c("CAFE MOLIDO NATURAL", "CARAMELO REGALIZ", "PALOMITAS SAL PACK",
                           "MELOCOTON ALM PACK") ~ "OTROS ALIMENTOS",
    
    # PRODUCTOS VARIOS
    nombre.producto %in% c("GUANTE RESIS.LEJÍA M", "GUANTE FLOCADO PEQU", "PERF.CEJAS MICRO",
                           "PERF.LABIOS", "PERF.AUT.LAB", "BLUSH SATÍN", "FIT ME", "CORRECTOR HYDRA-VI",
                           "PERF.AUT.OJOS", "BARRA COLOR BALM", "PERF. OJOS WATER", "BLUE II SLALOM",
                           "P. COLORCOR") ~ "PRODUCTOS VARIOS",
    
    # Para cualquier producto no clasificado
    TRUE ~ "OTROS"
  ))

```


#### 3.2.3 Tablas para facilitar la información que contienen los tickets

Realizamos las tablas necesarias para realizar un resumen analítico de los datos
proporcionados por los tickets.

TABLA 1: Resumen general de variables

```{r, echo= FALSE, message=FALSE, warning=FALSE}


## TABLA 1: Resumen general de variables

library(gt)
library(scales)

resumen_variable <- function(var) {
  tipo <- class(var)[1]
  n_na <- sum(is.na(var))
  miss_frac <- round(mean(is.na(var)), 4)

  if (is.factor(var) || is.character(var)) {
    niveles <- length(unique(var))
    top <- names(sort(table(var), decreasing = TRUE))[1]
    top_count <- max(table(var))
    top_frac <- round(top_count / length(var), 4)
  } else {
    niveles <- NA
    top <- NA
    top_count <- NA
    top_frac <- NA
  }

  tibble(
    tipo = tipo,
    niveles = niveles,
    topLevel = top,
    topCount = top_count,
    topFrac = top_frac,
    missFrac = miss_frac
  )
}

resumen <- bind_rows(lapply(df.ticket, resumen_variable), .id = "Variable")

resumen_variables <- resumen %>%
  mutate(
    Variable = str_to_title(gsub("\\.", " ", Variable)),
    tipo = case_when(
      tipo == "factor" ~ "Categórica",
      tipo == "character" ~ "Texto",
      tipo == "numeric" ~ "Numérica",
      tipo == "Date" ~ "Fecha",
      tipo == "Period" ~ "Hora",
      TRUE ~ tipo
    ),
    topFrac = percent(topFrac, accuracy = 0.1),
    missFrac = percent(missFrac, accuracy = 0.1)
  ) %>%
  gt() %>%
  tab_header(
    title = "Resumen General de Variables",
    subtitle = "Análisis descriptivo de las variables en los tickets"
  ) %>%
  cols_label(
    Variable = "Variable",
    tipo = "Tipo",
    niveles = "Niveles Ún.",
    topLevel = "Valor Más Frec.",
    topCount = "Frec.",
    topFrac = "% Total",
    missFrac = "Faltantes (%)"
  ) %>%
  sub_missing(columns = everything(), missing_text = "-") %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  tab_options(
    table.width = pct(95),  # Reducir ligeramente el ancho
    table.font.size = px(10),  # Fuente más pequeña
    column_labels.font.size = px(11),  # Encabezados un poco más grandes
    data_row.padding = px(3) # Menor espacio interno en celdas
  ) %>%
  cols_width(  # Ajustar ancho de columnas manualmente
    Variable ~ px(120),
    tipo ~ px(80),
    niveles ~ px(70),
    topLevel ~ px(100),
    topCount ~ px(60),
    topFrac ~ px(70),
    missFrac ~ px(80)
  ) %>%
  tab_source_note("Fuente: Análisis de tickets electrónicos de Mercadona")

resumen_variables %>% as_raw_html()

resumen_variables
```
Vemos como la tabla 1 presenta un resumen de las variables contenidas en df.ticket, indicando el tipo, número de niveles (si corresponde), valor más frecuente, su frecuencia relativa y la fracción de valores perdidos.


TABLA 2: Estadísticos de variables numéricas

```{r, echo= FALSE, message=FALSE, warning=FALSE}
## TABLA 2: Estadísticos de variables numéricas

library(gt)

numericas <- df.ticket %>%
  select(where(is.numeric)) %>%
  summarise(across(
    everything(),
    list(
      Media = mean,
      Mediana = median,
      DesvEst = sd,
      Min = min,
      Max = max
    ),
    na.rm = TRUE
  )) %>%
  pivot_longer(cols = everything(),
               names_to = c("Variable", ".value"),
               names_sep = "_") %>%
  mutate(
    Variable = str_to_title(gsub("\\.", " ", Variable)),
    across(where(is.numeric), round, 2)
  ) %>%
  gt() %>%
  tab_header(
    title = "Estadísticos Descriptivos de Variables Cuantitativas",
    subtitle = "Tabla 2"
  ) %>%
  cols_label(
    Variable = "Variable",
    Media = "Media",
    Mediana = "Mediana",
    DesvEst = "Desv. Est.",
    Min = "Mínimo",
    Max = "Máximo"
  ) %>%
  fmt_number(columns = where(is.numeric), decimals = 2) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = px(12),
    data_row.padding = px(6)
  )

numericas

```
Observamos como en la tabla 2 se muestran los principales estadísticos descriptivos de las variables cuantitativas como el precio total del ticket, el IVA añadido y el precio sin IVA.

TABLA 3: Frecuencias de variables categóricas clave

```{r, echo= FALSE, message=FALSE, warning=FALSE}
## TABLA 3: Frecuencias de variables categóricas clave
library(flextable)
library(officer)

categoricas <- df.ticket %>%
  select_if(~ is.factor(.) || is.character(.)) %>%
  select(ciudad, metodo.pago, numero.centro) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Valor") %>%
  group_by(Variable, Valor) %>%
  summarise(Frecuencia = n(), .groups = "drop") %>%
  group_by(Variable) %>%
  arrange(desc(Frecuencia), .by_group = TRUE) %>%
  slice_head(n = 5)  # top 5 por categoría

categoricas <- categoricas %>%
  mutate(
    Variable = case_when(
      Variable == "ciudad" ~ "Ciudad",
      Variable == "metodo.pago" ~ "Método de Pago",
      Variable == "numero.centro" ~ "Número de Centro"
    ),
    Valor = as.character(Valor),
    Frecuencia = as.integer(Frecuencia),
    Porcentaje = percent(Frecuencia/sum(Frecuencia), accuracy = 0.1)
  ) %>%
  flextable() %>%
  set_header_labels(
    Variable = "Variable",
    Valor = "Valor",
    Frecuencia = "Frecuencia",
    Porcentaje = "Porcentaje"
  ) %>%
  add_header_row(
    values = c("Frecuencia de Valores en Variables Categóricas"),
    colwidths = 4
  ) %>%
  merge_v(j = "Variable") %>%
  theme_zebra() %>%
  fontsize(size = 11, part = "all") %>%
  padding(padding = 4, part = "all") %>%
  align(align = "center", part = "header") %>%
  align(align = "left", j = 2, part = "body") %>%
  align(align = "right", j = c(3,4), part = "body") %>%
  width(width = c(1.2, 2.5, 1.2, 1.2)) %>%
  bg(j = "Variable", bg = "#f7f7f7", part = "body") %>%
  color(color = "#333333", part = "all") %>%
  bold(part = "header") %>%
  set_table_properties(layout = "autofit")

categoricas
```

Visualizamos como la tabla 3 muestra las frecuencias más altas de tres variables categóricas clave: ciudad, método de pago y número de centro, lo que permite comenzar a observar patrones interesantes en los tickets.

## 3. Preguntas propuestas

-   Estas son las preguntas que tenemos que responder mediante el uso de
    gráficos:


    1)  ¿Cuáles son los 5 productos, de los vendidos por unidades, con
        más ventas? ¿Cuántas unidades de cada uno se han vendido?
```{r,echo=FALSE,fig.align="center"}
top_productos<-df.productos%>%
  group_by(nombre.producto)%>%# Primero agrupamos por los productos
  summarise(Unidades_Vendidas=sum(cantidad))%>%# Sumamos la cantidad de cada cantidad
  arrange(desc(Unidades_Vendidas))# Ordenamos las cantidades de manera descendente

top9<-head(top_productos,9)
ggplot(top9,aes(x=nombre.producto,y=Unidades_Vendidas))+
  geom_col(fill="lightgreen")+# Usamos el parametro fill para cambiar el color de relleno de las barras
  geom_text(aes(label=Unidades_Vendidas),vjust=-0.1)+# Para poner la cantidad encima de cada barra
  labs(title="Top 5 productos más vendidos por unidades",x="Producto",y="Unidades Vendidas"
  )+theme_minimal()+theme(axis.text.x=element_text(angle=45,hjust=1,size=10))# Usamos element_text para ajustar los nombres de los productos que estan en el eje X
```

En esta gráfica podemos observar los productos más vendidos por unidades. El producto con mayor número de ventas es la leche desnatada sin lactosa, con 24 unidades, seguido de las lonchas de queso de cabra con 20. También destacan productos como los yogures Activia, los copos de avena o la barra de pan campesina. Aunque el título indica un Top 5, se han incluido más productos para ofrecer una visión más completa del comportamiento de ventas. Este análisis permite identificar los productos más demandados.


    2)  Si consideramos la categoría de FRUTAS Y VERDURAS. Cuáles son
        los 5 productos más vendidos?¿Cuántos kilos se han vendido de
        cada uno de estos productos?
        
```{r,echo=FALSE,fig.align="center"}

# 1) Iniciamos la búsqueda de los 5 productos de la categoría de FRUTAS Y 
#    VERDURAS más vendidos, y el cálculo de los kilos vendidos de cada uno de 
#    ellos:

top_frutas_verduras <- df.productos %>%
  filter(categoria == "FRUTAS Y VERDURAS") %>% # filtramos los productos
  group_by(nombre.producto) %>% # agrupamos los datos por nombre de producto
  summarise(kilos_vendidos = sum(cantidad, na.rm = TRUE)) %>% # sumamos la cantidad por producto, ignorando NAs
  arrange(desc(kilos_vendidos)) %>% # ordenamos los productos de mayor a menor cantidad
  slice_head(n = 5) # seleccionamos los 5 productos con más cantidad

top_frutas_verduras

```

```{r, echo = FALSE}

# 2) Representación gráfica:

ggplot(top_frutas_verduras, aes(x = reorder(nombre.producto, -kilos_vendidos), 
                               y = kilos_vendidos)) +
  geom_col(fill = "#E0B0FF", width = 0.7) +
  geom_text(aes(label = kilos_vendidos), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, 
            size = 4,
            fontface = "bold") +
  labs(title = "TOP 5 - Frutas y verduras más vendidas",
       subtitle = "Cantidad vendida en kilos",
       x = "",
       y = "Kilos vendidos") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 25, hjust = 1, size = 10)) +
  scale_y_continuous(limits = c(0, max(top_frutas_verduras$kilos_vendidos) * 1.2))

```

        

    3)  Si consideramos la categoría de PESCADO. Cuáles son los 5
        productos más vendidos? ¿Cuántos kilos se han vendido de cada
        uno de estos productos ?
        
```{r,echo=FALSE,fig.align='center'}
# 1) Creamos un vector con los productos de la categoría PESCADO
productos_pescado <- c("ESCALOPIN SALMON", "BERBERECHO", "ATÚN CLARO OLIVA PK6", "BACALAO AHUMADO", "PORCIONES BACALAO", "ATÚN CLARO GIRAS PK6", "SALMÓN AHUMADO", "SARDINA AHUMADA")

# 2) Filtramos los productos de la categoría PESCADO
pescado <- df.productos %>%
  filter(nombre.producto %in% productos_pescado)

# 3) Agrupamos por producto y sumamos el total de kilos vendidos
top_pescado <- pescado %>%
  group_by(nombre.producto) %>% # Agrupamos los datos en función del producto
  summarise(Kilos_Vendidos = sum(cantidad, na.rm = TRUE)) %>% # Sumamos la cantidad de cada producto
  arrange(desc(Kilos_Vendidos)) %>% # Aplicamos un orden descendente
  slice_head(n = 5) # Seleccionamos los 5 productos con mas kilos vendidos

print(top_pescado)

# 4) Representamos los resultados en un gráfico de barras
ggplot(top_pescado, aes(x = reorder(nombre.producto, -Kilos_Vendidos), y = Kilos_Vendidos)) +
  geom_col(fill = "violet") + # Color de las barras
  geom_text(aes(label = Kilos_Vendidos), vjust = -0.3) + # Añadimos etiquetas con los valores
  labs(title = "Top 5 productos más vendidos en PESCADO", x = "Producto", y = "Kilos Vendidos") + # Títulos
  theme_minimal() # Aplicamos estilo minimalista
```
En la grafica podemos observar los productos mas vendidos de la categoria pescado y el total vendido en kilos de cada uno de ellos. En primer lugar, el escalopín de salmón lidera con 6 kilos vendidos, seguido por el berberecho con 3 kilos. Los productos atún claro en aceite de oliva, bacalao ahumado y porciones de bacalao comparten la misma cantidad de ventas, 2 kilos cada uno.

    4)  Muestra mediante un gráfico de líneas como ha variado el precio
        por kilo de las bananas y los plátanos en los tickets
        disponibles, a lo largo del tiempo.

```{r, echo=FALSE}
# Visualizando los datos en el data frame en el cual se encuentra cada uno de los productos, no hemos encontrado ninguna compra de platanos o bananas o algo que haga referencia a ellos. Por este motivo, ha sido imposible llevar a cabo una representaciñon de la evolución del kilo de bananas y platanos a lo largo del tiempo. No obstante, este es el código que se debería utilizar en el caso de que si que se hubieran llevado a cabo compras de estos productos.

# 1) Filtramos los productos Banana y Plátano
frutas <- df.productos %>%
  filter(nombre.producto %in% c("BANANA", "PLATANO CANARIO",""))

# 2) Calculamos el precio por kilo
frutas <- frutas %>%
  mutate(precio_por_kilo = precio.producto / cantidad)

# 3) Creamos el gráfico de líneas
ggplot(frutas, aes(x = fecha, y = precio_por_kilo, color = nombre.producto, group = nombre.producto)) +
  geom_line(size = 1) +
  geom_point() +
  labs(title = "Variación del precio por kilo de Bananas y Plátanos",
       x = "Fecha",
       y = "Precio por kilo (€)") +
  theme_minimal()
```


    5)  ¿Cuál es la procedencia de los tickets ?¿Qué ciudad/pueblo tiene
        un mayor número de tickets?
```{r,fig.align="center",echo=FALSE}
# Gráfico de ciudades con mayor número de tickets
ciudades_top <- df.ticket %>%
  count(ciudad) %>%
  arrange(desc(n)) %>%
  top_n(5, n)

ggplot(ciudades_top, aes(x = reorder(ciudad, n), y = n, fill = ciudad)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), hjust = -0.3, size = 3.5) +
  labs(title = "Top 5 ciudades con más tickets en Mercadona",
       x = "Ciudad",
       y = "Número de tickets") +
  coord_flip() +
  theme(legend.position = "none")
```
        
Valencia claramente lidera con 130 tickets. Alboraya aparece en segundo lugar con 50 tickets.

    6)  Muestra mediante un diagrama el número de tickets recogidos cada
        día de las semana. ¿Si tuvieses que cerrar un día entre semana
        qué día lo harías?
```{r,fig.align="center",echo=FALSE}
# Análisis de tickets por día de la semana
tickets_dia_semana <- df.ticket %>%
  mutate(dia_semana = wday(fecha, label = TRUE, week_start = 1, abbr = FALSE)) %>%
  count(dia_semana) %>%
  mutate(porcentaje = n / sum(n) * 100)

# Gráfico de barras
ggplot(tickets_dia_semana, aes(x = dia_semana, y = n, fill = dia_semana)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribución de tickets por día de la semana",
       x = "Día de la semana",
       y = "Número de tickets") +
  theme(legend.position = "none")
```
        

-   Además de las preguntas propuestas por el profesorado, como equipo
    hemos formulado algunas cuestiones adicionales que podemos abordar
    con los datos disponibles. Estas son las siguientes:

    7)  ¿Existe algún patrón en cuanto a la hora del día en que se
        realizan las compras?
```{r,fig.align="center",echo=FALSE}
tickets_hora<-df.ticket%>%
  mutate(hora_compra=hour(hora))%>%
  count(hora_compra)%>%
  arrange(hora_compra)

# 2) Gráfico mejorado sin librerías nuevas
ggplot(tickets_hora,aes(x=hora_compra, y=n, fill=n)) +
  geom_col(width=0.8, color="white") +                       # columnas con borde blanco
  scale_fill_gradient(low="lightblue",high="navy") +        # degradado de azul
  geom_text(aes(label=n),vjust=-0.5, size=3, color="black") +
  scale_x_continuous(breaks=0:23) +                            # mostrar todas las horas
  labs(
    title= "Compras por Hora del Día",
    subtitle= "Número de tickets registrados por cada hora",
    x= "Hora (0–23)",
    y= "Número de tickets",
    fill= "Cantidad"
  ) +
  theme_minimal(base_size=14)                            

```
Las horas a las que mas compras hay es justo antes de cenar, donde la gente vuelve del trabajo y baja a comprar la cena y donde menos hay es por la mañana, a la hora de comer y a la hora de cenar, lo que tiene sentido ya que están comprando lo que van a necesitar para preparar su comida o su cena         

    8)  ¿Cuánto dinero de media se gastan los compradores?
```{r,fig.align="center",echo=FALSE}
gasto_medio<-df.ticket %>%
  summarise(gasto_promedio=mean(precio.total,na.rm=TRUE)) %>%
  pull(gasto_promedio)
ggplot(df.ticket,aes(x=precio.total)) +
  geom_histogram(binwidth=5,fill="lightcoral",color="white") +
  geom_vline(xintercept=gasto_medio,linetype="dashed",linewidth = 1) +
  annotate("text",x=gasto_medio + 5,y=Inf,label=paste0("Media = ",round(gasto_medio,2)," €"),
           vjust=2, hjust=0,
           size=4) +
  labs(
    title= "Distribución del gasto por ticket",
    x= "Gasto por ticket (€)",
    y= "Frecuencia"
  ) +
 theme_minimal()
```
A partir de esta gráfica se puede ver que  la media da 46,31€ pese a que la mayoria de las compras sean mas baratas debido a algunas compras muy grandes que han habido en nustro conjunto de datos 

    9)  ¿Cuanto dinero se suele añadir con el IVA?
    
```{r,echo=FALSE,fig.align="center"}
# Debemos calcular el valor medio de la columna "iva.anayadido":

iva_medio <- df.ticket %>%
  summarise(iva_promedio = mean(iva_anyadido, na.rm = TRUE))

## NO consideramos los valores NA (faltantes)

# Representación:

ggplot(iva_medio, aes(x = 1, y = iva_promedio)) +
  geom_text(aes(label = paste0("IVA Promedio: ", round(iva_promedio, 2), " €")),
            size = 8, fontface = "bold", color = "#2E86C1") +
  theme_void() +
  theme(
    plot.background = element_rect(fill = "#EAF2F8", color = NA),
    plot.margin = margin(40, 40, 40, 40)
  )
```
    

    10) ¿Cuál es la tienda en la que más se ha comprado? (Dirección
        tienda)
```{r,fig.align="center",echo=FALSE}
df.ticket%>%
  count(direccion,sort=TRUE) %>% # Utilizamos count para contar las veces que aparece cada tienda
  ggplot(aes(x=direccion, y=n))+
  geom_col(fill="steelblue") +
  coord_flip()+  # gira para barras horizontales
  labs(title="Compras por tienda (dirección)",
       x="Dirección de la tienda",
       y="Número de compras") +
  theme_minimal()
```
En esta gráfica muestra el número de compras que se ha hecho en los Mercadonas según los datos que tenemos, podemos observar que la dirección que más se repite es C/QUART 120, donde se ha comprado un total de 51 ocasiones; esta calle  está situada en el corazón de Valencia (España) en una zona céntrica y bien comunicada. También hay que destacar la dirección C/ PINTOR PERIS ARAGÓ 34, la cual esta ubicada en el centro de Alboraya, donde se ha comprado 50 veces, lo cual concuerda con la anterior gráfica de la pregunta 5

    11) ¿Cuál es el alimento comprado más caro?

Como para hacer un gráfico de todos los productos que se han comprado
sería un poco difícil su comprensión ya que hay demasiados productos
diferentes, podemos optar por agrupar los productos por rangos de
precios y mostrar cuántos hay en cada rango. Esto genera una visión
general de la distribución de precios de los productos.

```{r,fig.align="center",echo=FALSE}
library(ggplot2)

# Filtramos los productos con precios entre 0 y 15€ (ya que mayores a este precio su precio no es el real, la importación de esos precios no esta correcta,ente)
df_filtrado <- subset(df.productos, precio.producto >= 0 & precio.producto <= 15)

# Definimos los intervalos personalizados 
breaks <- seq(0, 15, by = 1)

# Creamos los rangos de precios
precio_ranges <- cut(df_filtrado$precio.producto, breaks = breaks, include.lowest = TRUE, right = FALSE)

# Creamos un dataframe con la frecuencia de cada rango
df_plot <- as.data.frame(table(precio_ranges))
names(df_plot) <- c("Rango de Precio", "Cantidad")

# Creamos el gráfico
ggplot(df_plot, aes(x = `Rango de Precio`, y = Cantidad, fill = "Rango de Precio")) +
  geom_bar(stat = "identity") +
  labs(title = "Distribución de Precios de los Productos (0-15€)",
       x = "Rango de Precio (€)",
       y = "Cantidad de Productos",
       fill = "Rango de Precio") +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```



Y ahora, para encontrar los productos que están en el rango de precios
entre 12 y 15 euros y representarlos en un gráfico, primero filtraremos
el dataframe original para incluir solo los productos dentro de ese
rango y luego mostraremos esos productos en un gráfico.

```{r,fig.align="center",echo=FALSE}
# Filtramos el dataframe para incluir solo los productos dentro del rango de precios especificado
productos_rango1 <- df.productos[df.productos$precio.producto >= 12.50 & 
                                         df.productos$precio.producto <= 15, ]

productos_rango1 = head(productos_rango1,-2)

# Creamos un gráfico de barras horizontales para mostrar los productos en el 
#rango de precios especificado
ggplot(productos_rango1, aes(x = precio.producto, 
                            y = reorder(nombre.producto, precio.producto))) +
  geom_bar(stat = "identity", fill = "#FF6F61") +  # Cambiamos el color de las barras
  geom_text(aes(label = sprintf("%.0f", precio.producto)),
            hjust = -0.2, color = "black") +  # Agregamos etiquetas con el precio
  labs(title = "Productos más caros",
       x = "Precio",
       y = "Producto",
       subtitle = "Cantidad de productos y su precio") +  # Añadimos subtítulo
  theme_minimal()
```


Por tanto, como podemos observar el alimento comprado más caro es el
bogavante crudo el cual solo se ha comprado 1 vez, el cual su precio es
de casi 15€.

## 4. Conclusiones

Para concluir, nos gustaría expresar los beneficios que nos ha supuesto realizar este trabajo.
La resolución de las preguntas planteadas sobre los tickets de Mercadona y la extracción de las
variables que tiene cada ticket nos han ayudado a saber más acerca de Mercadona, ya sean los producto 
más vendidos en diferentes categorías (fruta, pescado), la hora de más afluencia de gente comprando, 
el dinero de media que se gastan los compradores...

Este proyecto ha sido fundamental para ampliar nuestro conocimiento sobre el conjunto de datos. Además,
hemos adquirido experiencia en la resolución de los desafíos comunes que surgen al trabajar con datos.
Esta experiencia nos ha permitido comprender mejor las complejidades involucradas en el análisis de 
datos y cómo abordarlas de manera efectiva en futuros proyectos.

Este proyecto ha sido de suma importancia, ya que nos ha proporcionado la invaluable experiencia de 
abordar una problemática desde cero, trabajando con datos y extrayendo conclusiones significativas. 

Es importante señalar que los resultados de este proyecto deben ser interpretados con precaución debido
a la limitada cantidad de datos disponibles. En estudios similares, se suelen analizar millones de tickets
electrónicos para obtener conclusiones más sólidas y representativas de los hábitos de compra. 

Este proyecto ha sido una oportunidad invaluable para mejorar nuestras habilidades de trabajo en equipo.
Durante el proceso, hemos enfrentado decisiones conjuntas que han fortalecido nuestra colaboración y 
capacidad para trabajar de manera efectiva como grupo. Estas experiencias seguramente nos serán útiles 
en futuros proyectos, donde la capacidad de tomar decisiones en equipo juega un papel crucial en el éxito 
general del trabajo.

En definitiva, este trabajo nos ha servido para mejorar en valores y para iniciarnos en el mundo de 
los datos y su análisis.
