---
title: "ProyectoTD2025    -    Grupo C"
author: "David Puertes Santonja"
date: "2025-04-08"
output:
  pdf_document:
    toc: true
    toc_depth: 5
    number_sections: false
  html_notebook:
    echo: true
    number_sections: true
    toc: true
  bookdown::pdf_document2:
    toc: true
    toc_depth: 5
    number_sections: false
  html_document:
    echo: true
    number_sections: false
    theme: lumen
    toc: true
  bookdown::html_document2:
    echo: true
    number_sections: false
    theme: spacelab
    toc: true
always_allow_html: true
params:
  lang: ES
lang: "`r switch(params$lang, ES = 'es-ES', EN = 'en-US')`"
subtitle: "Tratamiento de Datos. Grado en Ciencia de Datos- UV"
language:
  label:
    fig: 'Figura '
    tab: 'Tabla '
    eq: 'Ecuación '
    thm: 'Teorema '
    lem: 'Lema '
    def: 'Definición '
    cor: 'Corolario '
    prp: 'Proposición '
    exm: 'Ejemplo '
    exr: 'Ejercicio '
    proof: 'Demostración. '
    remark: 'Nota: '
    solution: 'Solución. '
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Introducción

Este proyecto se centra en realizar un análisis detallado de los tickets
electrónicos proporcionados por Mercadona, una reconocida cadena de
supermercados en España. Estos tickets electrónicos son enviados a los
usuarios a través del correo electrónico en formato PDF.

Los datos utilizados en este análisis provienen de los tickets
electrónicos implementados por Mercadona. Estos documentos contienen
información detallada sobre las transacciones de compra realizadas en
sus establecimientos.

El objetivo principal es examinar a fondo estos tickets electrónicos
para obtener información valiosa sobre los hábitos de compra en
Mercadona. Específicamente, se enfocarán en identificar las compras más
comunes, los supermercados más visitados, los productos más populares y
que localidad tiene mayor número de tickets entre otras cosas.

```{r, echo = FALSE, message=FALSE}

if (!require("pacman")) {
  install.packages("pacman")
}
```

```{r, warning=FALSE}

library(pacman)

p_load(
  bookdown,
  kableExtra,
  tidyverse, # Manipulación de datos
  readr, # Entrada de datos
  dplyr, # Manipulación de datos
  tidyr, # Manipulación de datos
  purrr, # Manipulación de datos
  lubridate, # Manipulación de datos tipo fecha
  hrbrthemes, # Visualización de datos
  arules # Análisis patrones de compra
  )
```

## 1.2 Extracción de datos del fichero de texto

### 1.2.1 Recopilación de ficheros .txt

Con el propósito de simplificar el procesamiento de los datos contenidos
en los tickets de Mercadona, se ha optado por utilizar un código en
Python que convierte los archivos PDF a archivos de txt.

Todos estos archivos se encuentran almacenados en una carpeta compartida
designada para este tipo de archivos [./data], a la cual se accede para
obtener todos los tickets en formato .txt.

Este enfoque permite realizar un análisis línea por línea de cada
documento de manera eficiente y estructurada.

```{r}

# Obtenemos todos los ficheros de tipo texto para su siguiente análisis
rutadatos <- './data'
extension = '.txt'
elementos.carpeta <- list.files(path = rutadatos, 
                                pattern = extension,
                                full.names = TRUE, 
                                include.dirs = FALSE)

```

### 1.2.2 Recopilación de los datos

Una vez que todos los tickets han sido recolectados y transformados en
texto plano, es momento de almacenar la información contenida en ellos.


-   ***df.ticket***: Este data frame recopila la información general de
    cada ticket.


#### 1.2.2.1 Recogida de datos generales del ticket



##### Importación

```{r echo=FALSE}

# Creamos el dataframe más general que contiene la información individual de
# cada ticket
df.ticket <- data.frame()

for (d in elementos.carpeta) {
  
  contenido <- readLines(d,
                         encoding = 'latin1',
                         warn = FALSE)
  
  # Dirección, Ciudad y Código Postal 
  direccion <- contenido[2]
  
  linea3 <- unlist(strsplit(contenido[3], "\\s+"))
  cp <- linea3[1]
  provincia <- linea3[2]
  
  # Teléfono (ahora en línea 5)
  telefono <- gsub(".*: ", "", contenido[5])
  
  # Fecha, hora y número de operación 
  linea6 <- unlist(strsplit(contenido[6], " "))
  fecha_compra <- linea6[1]
  hora_compra <- linea6[2]
  num_operacion <- gsub("OP: ", "", contenido[7])
  
  # Número de factura simplificada (línea 8)
  num_factura_simpl <- gsub("FACTURA SIMPLIFICADA: ", "", contenido[8])
  

  # Precio total y precio sin IVA 
# Precio total y precio sin IVA 
  # Precio total y precio sin IVA 
patron2 <- "TOTAL"
pos <- grep(patron2, contenido)[1]  # Busca la línea que contiene "TOTAL"
precio_total <- contenido[pos + 1]  # El precio total está en la línea siguiente
precio_total <- as.numeric(gsub(",", ".", precio_total))  # Convierte el precio a numérico

  
  # Buscar todas las apariciones del patrón "TOTAL"
  patron2 <- "TOTAL"
  pos_totales <- grep(patron2, contenido)

  # Precio total (sin IVA) está en la segunda coincidencia de   "TOTAL"
  precio_total_sin_iva <- contenido[pos_totales[2] + 1]  # El precio está en la siguiente línea
  precio_total_sin_iva <- as.numeric(gsub(",", ".", x =precio_total_sin_iva)) 
  
  iva_anyadido <- contenido[pos_totales[2] + 2]  # El precio está en la siguiente línea
  iva_anyadido <- as.numeric(gsub(",", ".", x =iva_anyadido))  

  
  # Detalles de la autorización 
  patronNC <- "N\\.C"
  posNC <- grep(patronNC, contenido)[1]
  nc <- gsub("N.C: ", "", unlist(strsplit( contenido[posNC], " " ))[2])
  aut <- unlist(strsplit( contenido[posNC+1], " " ))[3] 
  aid <- unlist(strsplit( contenido[posNC+1], " " ))[4]
  arc <- unlist(strsplit( contenido[posNC+2], " " ))[2]
  
  # Tipo de tarjeta y método de pago
  autor_trans <- contenido[posNC+3]
  # Buscamos el método de pago 
  patron_metodo_pago <- "TARJETA BANCARIA|Mastercard|Visa"
  pos_metodo_pago <- grep(patron_metodo_pago, contenido)

# Si se encuentra un patrón, asignamos el valor del método de pago
  metodo_pago <- NA
  if (length(pos_metodo_pago) > 0) {
    metodo_pago <- contenido[pos_metodo_pago[1]]  # Tomamos la primera   coincidencia
    metodo_pago <- gsub("TARJETA BANCARIA: ", "", metodo_pago)  #     Eliminar el texto "TARJETA BANCARIA: "
    metodo_pago <- gsub("MASTERCARD", "MASTERCARD", metodo_pago)  # Si es Mastercard
    metodo_pago <- gsub("VISA", "VISA", metodo_pago)  # Si es Visa
}

  
  # Añadimos las variables al dataframe
  fila <- data.frame(
    numero.factura = num_factura_simpl,
    precio.total = as.numeric(precio_total),
    precio.total.sin.IVA = as.numeric(precio_total_sin_iva),
    iva.anyadido = as.numeric(iva_anyadido),
    direccion = as.factor(direccion),
    ciudad = as.factor(provincia),
    codigo.postal = as.factor(cp),
    telefono = as.character(telefono),
    fecha = dmy(fecha_compra),
    hora = hm(hora_compra),
    tipo.tarjeta = as.factor(autor_trans),
    metodo.pago = as.factor(metodo_pago),
    autorizacion.pago = aut,
    identificacion.aplicacion.pago = arc,
    autorizacion.transaccion = as.factor(autor_trans),
    numero.centro = nc,
    numero.caja = num_operacion
  )
  
  df.ticket <- bind_rows(df.ticket, fila)
}

# Realizamos las tablas necesarias para visualizar el análisis llevado a cabo:

## TABLA 1: Resumen general de variables
resumen_variable <- function(var) {
  tipo <- class(var)[1]
  n_na <- sum(is.na(var))
  miss_frac <- round(mean(is.na(var)), 4)

  if (is.factor(var) || is.character(var)) {
    niveles <- length(unique(var))
    top <- names(sort(table(var), decreasing = TRUE))[1]
    top_count <- max(table(var))
    top_frac <- round(top_count / length(var), 4)
  } else {
    niveles <- NA
    top <- NA
    top_count <- NA
    top_frac <- NA
  }

  tibble(
    tipo = tipo,
    niveles = niveles,
    topLevel = top,
    topCount = top_count,
    topFrac = top_frac,
    missFrac = miss_frac
  )
}

resumen <- bind_rows(lapply(df.ticket, resumen_variable), .id = "Variable")

knitr::kable(
  resumen,
  caption = "Tabla 1. Resumen general de las variables del conjunto de tickets.",
  digits = 4
) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

# La tabla 1 presenta un resumen de las variables contenidas en df.ticket, indicando el tipo, número de niveles (si corresponde), valor más frecuente, su frecuencia relativa y la fracción de valores perdidos.
```

```{r}
## TABLA 2: Estadísticos de variables numéricas
numericas <- df.ticket %>%
  select(where(is.numeric)) %>%
  summarise(across(
    everything(),
    list(
      Media = mean,
      Mediana = median,
      DesvEst = sd,
      Min = min,
      Max = max
    ),
    na.rm = TRUE
  )) %>%
  pivot_longer(cols = everything(),
               names_to = c("Variable", ".value"),
               names_sep = "_")

knitr::kable(
  numericas,
  caption = "Tabla 2. Estadísticos descriptivos de las variables numéricas.",
  digits = 2
) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

# En la tabla 2 se muestran los principales estadísticos descriptivos de las variables cuantitativas como el precio total del ticket, el IVA añadido y el precio sin IVA.
```


```{r}
## TABLA 3: Frecuencias de variables categóricas clave
categoricas <- df.ticket %>%
  select_if(~ is.factor(.) || is.character(.)) %>%
  select(ciudad, metodo.pago, numero.centro) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Valor") %>%
  group_by(Variable, Valor) %>%
  summarise(Frecuencia = n(), .groups = "drop") %>%
  group_by(Variable) %>%
  arrange(desc(Frecuencia), .by_group = TRUE) %>%
  slice_head(n = 5)  # top 5 por categoría

knitr::kable(
  categoricas,
  caption = "Tabla 3. Frecuencia de los valores más comunes en variables categóricas clave.",
  digits = 0
) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

# La tabla 3 muestra las frecuencias más altas de tres variables categóricas clave: ciudad, método de pago y número de centro, lo que permite comenzar a observar patrones interesantes en los tickets.
```

